---
counter: true
---

# Structure from Motion

??? abstract "æ ¸å¿ƒçŸ¥è¯†"

    æœ¬è®²å†…å®¹å¾ˆå¤šï¼Œä¸”æ¶‰åŠåˆ°å¤§é‡æ•°å­¦å…¬å¼ã€‚å¤ä¹ çš„æ—¶å€™åªéœ€ç†è§£è®¡ç®—æ€è·¯ï¼Œä¸éœ€è¦è®°ä½ç¹æ‚çš„å…¬å¼ã€‚

    - ç›¸æœºæ¨¡å‹ï¼šä¸‰ç»´ç‚¹ -> äºŒç»´ç‚¹
        - åæ ‡å˜æ¢ï¼šæ±‚è§£å¤–å‚çŸ©é˜µ $M_{ext}$ï¼ˆä½ç½® $\bm{c}_w$ å’Œæœå‘ $R$ï¼‰
        - é€è§†æŠ•å½±ï¼šæ±‚è§£å†…å‚çŸ©é˜µ $M_{int}$ï¼ˆç„¦è· $f$ï¼‰
        - å›¾åƒå¹³é¢ï¼ˆæ¯«ç±³ï¼‰-> å›¾åƒä¼ æ„Ÿå™¨ï¼ˆåƒç´ ï¼‰ï¼šæ±‚è§£å†…å‚çŸ©é˜µ $M_{int}$ï¼ˆåƒç´ å¯†åº¦ $m_x, m_y$ å’Œä¸»ç‚¹åæ ‡ $c_x, c_y$ï¼‰
    - ç›¸æœºæ ‡å®šï¼šå¯»æ‰¾å†…å¤–å‚
        - å³æ±‚è§£æŠ•å½±çŸ©é˜µï¼ˆ= å†…å‚çŸ©é˜µ * å¤–å‚çŸ©é˜µï¼‰
        - åˆ†è§£ï¼ˆQR åˆ†è§£ï¼‰
        - è§†è§‰å®šä½ï¼ˆPnPï¼‰
    - è¿åŠ¨æ¢å¤ç»“æ„ï¼ˆSfMï¼‰ï¼šå·²çŸ¥äºŒç»´ç‚¹å’Œå†…å‚ï¼Œæ±‚å¤–å‚ï¼ˆç›¸æœºä½ç½®å’Œæœå‘ï¼‰å’Œä¸‰ç»´ç‚¹
        - æ•°å­¦åŸºç¡€ï¼šå¯¹æå‡ ä½•ã€æœ¬è´¨çŸ©é˜µå’ŒåŸºç¡€çŸ©é˜µ
        - ç›¸å¯¹ç›¸æœºä½å§¿ä¼°è®¡ï¼šæ±‚ $R, \bm{t}$
        - ä¸‰è§’åŒ–ï¼šå·²çŸ¥äºŒç»´ç‚¹å’Œå†…å¤–å‚ï¼Œæ±‚ä¸‰ç»´ç‚¹åæ ‡
        - å¤šå¸§è¿åŠ¨æ¢å¤ç»“æ„ï¼šå…‰æŸæ³•å¹³å·®

**è¿åŠ¨æ¢å¤ç»“æ„**(structure from motion, **SfM**)ï¼šä»å¤šå¼ å›¾åƒä¸­æ¢å¤åœºæ™¯çš„**ç›¸æœºä½å§¿**å’Œ**ä¸‰ç»´ç»“æ„**ã€‚

<div style="text-align: center">
    <img src="images/lec7/1.png" width=60% />
</div>

???+ example "ç›¸å…³åº”ç”¨"

    - [å¤šè§†è§’ç«‹ä½“](8.md#multi-view-stereo)(multi-view stereo)

        <div style="text-align: center">
            <img src="images/lec7/2.png" width=50% />
        </div>

    - [è§†è§‰å®šä½](#visual-localization-problem)(visual localization)

        <div style="text-align: center">
            <img src="images/lec7/3.png" width=50% />
        </div>

    - SLAMï¼ˆåŒæ—¶å®šä½ä¸åœ°å›¾æ„å»º(simultaneous localization and mapping)ï¼‰

        <div style="text-align: center">
            <img src="images/lec7/4.png" width=40% />
        </div>

ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

- **ç›¸æœºæ¨¡å‹**ï¼šç›¸æœºå¦‚ä½•å°†ä¸–ç•Œä¸­çš„ä¸‰ç»´ç‚¹æ˜ å°„åˆ°å›¾åƒå¹³é¢ä¸Š
- **ç›¸æœºæ ‡å®šä¸ä½å§¿ä¼°è®¡**(camera calibration and pose estimation)ï¼šå¦‚ä½•è®¡ç®—ç›¸æœºç›¸å¯¹äºä¸–ç•Œåæ ‡ç³»çš„ä½ç½®å’Œæ–¹å‘
- **è¿åŠ¨æ¢å¤ç»“æ„**ï¼šå¦‚ä½•ä»å›¾åƒä¸­é‡å»ºæœªçŸ¥çš„ä¸‰ç»´ç»“æ„ï¼Œå³æ ¹æ®åœºæ™¯å’Œå¤šè§†è§’ï¼ˆå›¾åƒï¼‰ä¸‹çš„ç›¸æœºä½å§¿æ¥è®¡ç®—ä¸‰ç»´ç»“æ„


## Camera Model

### Image Formation

æˆåƒæ­¥éª¤ï¼š

1. **åæ ‡å˜æ¢**ï¼šä¸–ç•Œåæ ‡ç³» -> ç›¸æœºåæ ‡ç³»
2. **é€è§†æŠ•å½±**ï¼šç›¸æœºåæ ‡ç³» -> äºŒç»´å›¾åƒå¹³é¢
3. å›¾åƒå¹³é¢åˆ°å›¾åƒä¼ æ„Ÿå™¨çš„æ˜ å°„ï¼šä»¥æ¯«ç±³ä¸ºå•ä½çš„äºŒç»´åæ ‡ -> ä»¥åƒç´ ä¸ºå•ä½çš„åƒç´ åæ ‡

<div style="text-align: center">
    <img src="images/lec7/5.png" width=60% />
</div>

å…¶ä¸­ç¬¬ä¸€æ­¥éœ€è¦æ±‚è§£**å¤–å‚çŸ©é˜µ**(extrinsic matrix)ï¼Œåä¸¤æ­¥éœ€è¦æ±‚è§£**å†…å‚çŸ©é˜µ**(intrinsic matrix)ã€‚


### Coordinate Transformation

åæ ‡å˜æ¢çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š

<div style="text-align: center">
    <img src="images/lec7/6.png" width=50% />
</div>

ç›¸æœºçš„**å¤–å‚**(extrinsic parameters)åŒ…å«ï¼š

- ç›¸æœºåœ¨ä¸–ç•Œåæ ‡ç³» $W$ ä¸­çš„**ä½ç½®**(position) $\bm{c}_w$
- ç›¸æœºåæ ‡ç³»åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„**æœå‘**(orientation) $R$ï¼ˆä¸€ä¸ªä¸‰ç»´æ—‹è½¬çŸ©é˜µï¼‰

$$
R = 
\begin{bmatrix}
r_{11} & r_{12} & r_{13} \\
r_{21} & r_{22} & r_{23} \\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
\begin{array}{l}
\rightarrow\ \text{Row 1: Direction of } \hat{x}_c \text{ in world coordinate frame} \\
\rightarrow\ \text{Row 2: Direction of } \hat{y}_c \text{ in world coordinate frame} \\
\rightarrow\ \text{Row 3: Direction of } \hat{z}_c \text{ in world coordinate frame}
\end{array}
$$

å…¶ä¸­æ—‹è½¬çŸ©é˜µ $R$ æ˜¯**æ ‡å‡†æ­£äº¤çš„**(orthonormal)ã€‚

å¯¹äºç»™å®šçš„ç›¸æœºå¤–å‚ $(R, c_w)$ï¼Œç‚¹ $P$ åœ¨ç›¸æœºåæ ‡ç³»ä¸­çš„ä½ç½®ä¸ºï¼š

$$
\bm{x}_c=R(\bm{x}_w-\bm{c}_w)=R\bm{x}_w-R\bm{c}_w=R\bm{x}_w+\bm{t} \quad \bm{t} = -R\bm{c}_w \\
\bm{x}_c=\begin{bmatrix}x_c\\y_c\\z_c\end{bmatrix}=\begin{bmatrix}r_{11}&r_{12}&r_{13}\\r_{21}&r_{22}&r_{23}\\r_{31}&r_{32}&r_{33}\end{bmatrix}\begin{bmatrix}x_w\\y_w\\z_w\end{bmatrix}+\begin{bmatrix}t_x\\t_y\\t_z\end{bmatrix}
$$

å°†ä¸Šè¿°æ–¹ç¨‹é‡å†™ä¸ºé½æ¬¡åæ ‡çš„å½¢å¼ï¼š

$$
\tilde{\bm{x}}_c=\begin{bmatrix}x_c\\y_c\\z_c\\1\end{bmatrix}=\begin{bmatrix}r_{11}&r_{12}&r_{13}&t_x\\r_{21}&r_{22}&r_{23}&t_y\\r_{31}&r_{32}&r_{33}&t_z\\0&0&0&1\end{bmatrix}\begin{bmatrix}x_w\\y_w\\z_w\\1\end{bmatrix}
$$

**å¤–å‚çŸ©é˜µ** $M_{ext}=\begin{bmatrix}R_{3\times3}&\bm{t}\\\bm{0}_{1\times3}&1\end{bmatrix}=\begin{bmatrix}r_{11}&r_{12}&r_{13}&t_x\\r_{21}&r_{22}&r_{23}&t_y\\r_{31}&r_{32}&r_{33}&t_z\\0&0&0&1\end{bmatrix}$


### Perspective Projection

é€è§†æŠ•å½±çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

<div style="text-align: center">
    <img src="images/lec7/8.png" width=50% />
</div>

æœ‰å…³é€è§†æŠ•å½±çš„å…·ä½“ä»‹ç»è§[ã€Œæˆåƒã€ä¸€è®²çš„ç¬”è®°](2.md#perspective-projection)ã€‚


### Image Plane to Image Sensor Mapping

<div style="text-align: center">
    <img src="images/lec7/9.png" width=50% />
</div>

>åƒç´ ä¹Ÿæœ‰å¯èƒ½æ˜¯çŸ©å½¢çš„ã€‚

è‹¥ $m_x, m_y$ åˆ†åˆ«è¡¨ç¤º $x, y$ æ–¹å‘ä¸Šçš„**åƒç´ å¯†åº¦**ï¼ˆpixels/mmï¼‰ï¼Œé‚£ä¹ˆåƒç´ åæ ‡ä¸ºï¼š

$$
u=m_xx_i=m_xf\frac{x_c}{z_c} \quad \quad v=m_yy_i=m_yf\frac{y_c}{z_c}
$$

æˆ‘ä»¬é€šå¸¸å°†å›¾åƒä¼ æ„Ÿå™¨çš„**å·¦ä¸Šè§’**ä½œä¸º**åŸç‚¹**ï¼ˆè¿™æ ·ä¾¿äºç´¢å¼•ï¼‰ã€‚è‹¥åƒç´  $(c_x, c_y)$ æ˜¯å…‰è½´ç©¿è¿‡ä¼ æ„Ÿå™¨çš„**ä¸»ç‚¹**(principle point)ï¼Œé‚£ä¹ˆï¼š
$$
u=m_xf\frac{x_c}{z_c}+c_x \quad \quad v=m_yf\frac{y_c}{z_c}+c_y
$$

è½¬æ¢ä¸ºé½æ¬¡åæ ‡å½¢å¼ï¼š

$$
\begin{bmatrix}u\\v\\1\end{bmatrix}=\begin{bmatrix}f_x&0&c_x\\0&f_y&c_y\\0&0&1\end{bmatrix}\begin{bmatrix}x_c\\y_c\\z_c\end{bmatrix}=\begin{bmatrix}f_x&0&c_x&0\\0&f_y&c_y&0\\0&0&1&0\end{bmatrix}\begin{bmatrix}x_c\\y_c\\z_c\\1\end{bmatrix}
$$

å…¶ä¸­ $f_x = m_x f, f_y = m_y f$ã€‚å› æ­¤**å†…å‚çŸ©é˜µ** $M_{int} = \begin{bmatrix}f_x&0&c_x&0\\0&f_y&c_y&0\\0&0&1&0\end{bmatrix}$ã€‚


### Conclusion

<div style="text-align: center">
    <img src="images/lec7/10.png" width=60% />
</div>

ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å®Œæ•´çš„**æŠ•å½±çŸ©é˜µ** $P$ äº†ï¼š
$$
\widetilde{\bm{u}}=\textcolor{red}{M_{int}M_{ext}}\tilde{\bm{x}}_w=\textcolor{red}{P}\tilde{\bm{x}}_w
$$

å³ï¼š

$$
\begin{bmatrix}\tilde{u}\\\tilde{v}\\\tilde{w}\end{bmatrix}=\begin{bmatrix}p_{11}&p_{12}&p_{13}&p_{14}\\p_{21}&p_{22}&p_{23}&p_{24}\\p_{31}&p_{32}&p_{33}&p_{34}\end{bmatrix}\begin{bmatrix}x_w\\y_w\\z_w\\1\end{bmatrix}
$$


## Camera Calibration

**ç›¸æœºæ ‡å®š**(camera calibration)æŒ‡çš„æ˜¯å¯»æ‰¾å†…å‚å’Œå¤–å‚çš„è¿‡ç¨‹ã€‚


### Procedure

è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š

1. æ‹æ‘„ä¸€ä¸ªå·²çŸ¥å‡ ä½•å½¢çŠ¶çš„ç‰©ä½“å›¾åƒï¼ˆæ¯”å¦‚**æ ‡å®šæ¿**(calibration board)ï¼‰

    <div style="text-align: center">
        <img src="images/lec7/11.png" width=30% />
    </div>

<!-- - æœ‰æ—¶å¯èƒ½éœ€è¦ä»¥ä¸åŒä½å§¿æ‹æ‘„åŒä¸€ä¸ªæ ‡å®šç›®æ ‡ï¼š

    <div style="text-align: center">
        <img src="images/lec7/30.png" width=50% />
    </div> -->

2. è¯†åˆ«ä¸‰ç»´åœºæ™¯ç‚¹å’Œå›¾åƒç‚¹ä¹‹é—´çš„å¯¹åº”å…³ç³»

    <div style="text-align: center">
        <img src="images/lec7/12.png" width=60% />
    </div>

3. å¯¹äºåœºæ™¯å’Œå›¾åƒä¸­æ¯ä¸€ä¸ªå¯¹åº”ç‚¹ $i$ï¼Œæœ‰æ–¹ç¨‹ï¼š

    $$
    \underbrace{
    \begin{bmatrix}
    u^{(i)} \\
    v^{(i)} \\
    1
    \end{bmatrix}
    }_{\text{Known}}
    \equiv
    \underbrace{
    \begin{bmatrix}
    p_{11} & p_{12} & p_{13} & p_{14} \\
    p_{21} & p_{22} & p_{23} & p_{24} \\
    p_{31} & p_{32} & p_{33} & p_{34}
    \end{bmatrix}
    }_{\text{Unknown}}
    \underbrace{
    \begin{bmatrix}
    x_w^{(i)} \\
    y_w^{(i)} \\
    z_w^{(i)} \\
    1
    \end{bmatrix}
    }_{\text{Known}}
    $$

    æˆç«‹ã€‚å°†çŸ©é˜µä¹˜æ³•æ‰©å†™ä¸ºçº¿æ€§æ–¹ç¨‹ï¼š

    $$
    u^{(i)} = \frac{p_{11}x_w^{(i)} + p_{12}y_w^{(i)} + p_{13}z_w^{(i)} + p_{14}}{p_{31}x_w^{(i)} + p_{32}y_w^{(i)} + p_{33}z_w^{(i)} + p_{34}} \\
    v^{(i)} = \frac{p_{21}x_w^{(i)} + p_{22}y_w^{(i)} + p_{23}z_w^{(i)} + p_{24}}{p_{31}x_w^{(i)} + p_{32}y_w^{(i)} + p_{33}z_w^{(i)} + p_{34}}
    $$

4. é‡æ–°å®‰æ’å„å…ƒç´ ï¼ˆå·²çŸ¥é‡æ”¾åœ¨çŸ©é˜µ $A$ ä¸­ï¼ŒæœªçŸ¥çš„æŠ•å½±çŸ©é˜µå‚æ•°æ”¾åœ¨å‘é‡ $\bm{p}$ ä¸­ï¼‰ï¼š

    $$
    \underbrace{
    \begin{bmatrix}
    x_w^{(1)} & y_w^{(1)} & z_w^{(1)} & 1 & 0 & 0 & 0 & 0 & -u_1x_w^{(1)} & -u_1y_w^{(1)} & -u_1z_w^{(1)} & -u_1 \\
    0 & 0 & 0 & 0 & x_w^{(1)} & y_w^{(1)} & z_w^{(1)} & 1 & -v_1x_w^{(1)} & -v_1y_w^{(1)} & -v_1z_w^{(1)} & -v_1 \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    x_w^{(i)} & y_w^{(i)} & z_w^{(i)} & 1 & 0 & 0 & 0 & 0 & -u_ix_w^{(i)} & -u_iy_w^{(i)} & -u_iz_w^{(i)} & -u_i \\
    0 & 0 & 0 & 0 & x_w^{(i)} & y_w^{(i)} & z_w^{(i)} & 1 & -v_ix_w^{(i)} & -v_iy_w^{(i)} & -v_iz_w^{(i)} & -v_i \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    x_w^{(n)} & y_w^{(n)} & z_w^{(n)} & 1 & 0 & 0 & 0 & 0 & -u_nx_w^{(n)} & -u_ny_w^{(n)} & -u_nz_w^{(n)} & -u_n \\
    0 & 0 & 0 & 0 & x_w^{(n)} & y_w^{(n)} & z_w^{(n)} & 1 & -v_nx_w^{(n)} & -v_ny_w^{(n)} & -v_nz_w^{(n)} & -v_n \\
    \end{bmatrix}
    }_{A\ (\text{Known})}
    \underbrace{
    \begin{bmatrix}
    p_{11} \\ p_{12} \\ p_{13} \\ p_{14} \\ p_{21} \\ p_{22} \\ p_{23} \\ p_{24} \\ p_{31} \\ p_{32} \\ p_{33} \\ p_{34}
    \end{bmatrix}}_{\bm{p}\ (\text{Unknown})} = \begin{bmatrix}
    0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0
    \end{bmatrix}
    $$

5. è§£å‡º $p$

    $$
    A \bm{p} = 0
    $$


### Property of Projection Matrices: Scale

å·²çŸ¥ $\begin{bmatrix} \tilde{u} \\ \tilde{v} \\ \tilde{w} \end{bmatrix} \equiv k \begin{bmatrix} \tilde{u} \\ \tilde{v} \\ \tilde{w} \end{bmatrix}$ï¼Œå³ï¼š

$$
\begin{bmatrix}
p_{11} & p_{12} & p_{13} & p_{14} \\
p_{21} & p_{22} & p_{23} & p_{24} \\
p_{31} & p_{32} & p_{33} & p_{34}
\end{bmatrix}
\begin{bmatrix}
x_w \\
y_w \\
z_w \\
1
\end{bmatrix}
\equiv k
\begin{bmatrix}
p_{11} & p_{12} & p_{13} & p_{14} \\
p_{21} & p_{22} & p_{23} & p_{24} \\
p_{31} & p_{32} & p_{33} & p_{34}
\end{bmatrix}
\begin{bmatrix}
x_w \\
y_w \\
z_w \\
1
\end{bmatrix}
$$

å› æ­¤æŠ•å½±çŸ©é˜µ $P$ å’Œ $kP$ äº§ç”Ÿç›¸åŒçš„é½æ¬¡åƒç´ åæ ‡ã€‚ç”±æ­¤æˆ‘ä»¬å‘ç°æ€§è´¨ï¼šæŠ•å½±çŸ©é˜µ $P$ çš„å®šä¹‰æ˜¯**å°ºåº¦**(scale)æ— å…³çš„ã€‚


### Solving P

åŸºäºå°ºåº¦æ— å…³çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥åšå…¶ä¸­ä¸€ç§å¤„ç†ï¼š

1. è®¾ç½®å¥½å°ºåº¦ï¼Œä½¿å¾— $p_{34} = 1$
2. è®¾ç½®å¥½å°ºåº¦ï¼Œä½¿å¾— $\|\bm{p}\|^2 = 1$

æˆ‘ä»¬é€‰æ‹©ç¬¬ 2 ä¸ªé€‰é¡¹ï¼Œå¹¶å¸Œæœ› $A \bm{p}$ å°½å¯èƒ½æ¥è¿‘ 0ï¼Œäºæ˜¯å¾—åˆ°ä»¥ä¸‹ä¼˜åŒ–ç›®æ ‡ï¼š

$$
\min_{\bm{p}} ||\bm{A}\bm{p}||^2 \quad \text{such that} \quad ||\bm{p}||^2 = 1
$$

å¯ä»¥è¯æ˜ï¼šçŸ©é˜µ $A^TA$ ä¸­å¯¹åº”**æœ€å°ç‰¹å¾å€¼** $\lambda$ çš„ç‰¹å¾å‘é‡ $\bm{p}$ å°±æ˜¯æ–¹ç¨‹çš„è§£ã€‚

æœ€åï¼Œé‡æ–°æ’åˆ—è§£ $\bm{p}$ ä»¥å½¢æˆæŠ•å½±çŸ©é˜µ $P$ã€‚


### Decomposition

ç°åœ¨å·²ç»æ±‚å‡º $P$ äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¸Œæœ›èƒ½å°† $P$ åˆ†è§£ä¸ºå†…å‚çŸ©é˜µå’Œå¤–å‚çŸ©é˜µçš„ä¹˜ç§¯ï¼Œä»¥è¾¾æˆæ±‚è§£å†…å¤–å‚çš„ç›®æ ‡ã€‚

$$
P = 
\begin{bmatrix}
p_{11} & p_{12} & p_{13} & p_{14} \\
p_{21} & p_{22} & p_{23} & p_{24} \\
p_{31} & p_{32} & p_{33} & p_{34}
\end{bmatrix}
= \underbrace{\begin{bmatrix}
f_x & 0 & o_x & 0 \\
0 & f_y & o_y & 0 \\
0 & 0 & 1 & 0
\end{bmatrix}}_{M_{int}}
\underbrace{\begin{bmatrix}
r_{11} & r_{12} & r_{13} & t_x \\
r_{21} & r_{22} & r_{23} & t_y \\
r_{31} & r_{32} & r_{33} & t_z \\
0 & 0 & 0 & 1
\end{bmatrix}}_{M_{ext}}
$$

è§‚å¯Ÿä¸Šè¿°æ–¹ç¨‹ï¼Œå‘ç°å†…å‚çŸ©é˜µä¸­å­˜åœ¨ä¸€ä¸ª<span style="color: cornflowerblue">ä¸Šä¸‰è§’çŸ©é˜µ</span>ï¼ˆè®°ä½œ $K$ï¼‰ï¼Œè€Œå¤–å‚çŸ©é˜µä¸­çš„ $R$ï¼ˆ$r_{11}-r_{33}$ï¼‰æ˜¯<span style="color: yellowgreen">æ ‡å‡†æ­£äº¤</span>çŸ©é˜µï¼Œè¿™æ­£å¥½ç¬¦åˆ **QR åˆ†è§£**(QR factorization)çš„å®šä¹‰ã€‚äºæ˜¯å°†è¿™éƒ¨åˆ†ä»æŠ•å½±çŸ©é˜µä¸­æå–å‡ºæ¥å¹¶è¿›è¡Œè§£è€¦(decouple)ï¼Œå¾—åˆ°ï¼š

$$
\begin{bmatrix}
p_{11} & p_{12} & p_{13} \\
p_{21} & p_{22} & p_{23} \\
p_{31} & p_{32} & p_{33}
\end{bmatrix}
= \begin{bmatrix}
\textcolor{cornflowerblue}{f_x} & \textcolor{cornflowerblue}{0} & \textcolor{cornflowerblue}{o_x} \\
0 & \textcolor{cornflowerblue}{f_y} & \textcolor{cornflowerblue}{o_y} \\
0 & 0 & \textcolor{cornflowerblue}{1}
\end{bmatrix}
\begin{bmatrix}
\textcolor{yellowgreen}{r_{11}} & \textcolor{yellowgreen}{r_{12}} & \textcolor{yellowgreen}{r_{13}} \\
\textcolor{yellowgreen}{r_{21}} & \textcolor{yellowgreen}{r_{22}} & \textcolor{yellowgreen}{r_{23}} \\
\textcolor{yellowgreen}{r_{31}} & \textcolor{yellowgreen}{r_{32}} & \textcolor{yellowgreen}{r_{33}}
\end{bmatrix} = KR
$$

å¯¹äº $P$ çš„æœ€åä¸€åˆ—ï¼š

$$
\begin{bmatrix}p_{14}\\p_{24}\\p_{34}\end{bmatrix}=\begin{bmatrix}f_x&0&o_x\\0&f_y&o_y\\0&0&1\end{bmatrix}\begin{bmatrix}t_x\\t_y\\t_z\end{bmatrix}=K\bm{t}
$$

å› æ­¤ï¼š

$$
\bm{t}=K^{-1}\begin{bmatrix}p_{14}\\p_{24}\\p_{34}\end{bmatrix}
$$


### Visual Localization Problem

**è§†è§‰å®šä½**(visual localization)é—®é¢˜æ˜¯æŒ‡ç»™å®šä¸€å¼ æˆ–å¤šå¼ å›¾åƒï¼Œç¡®å®šç›¸æœºåœ¨ç‰¹å®šçš„ä¸‰ç»´ç©ºé—´ä¸­çš„ä½ç½®å’Œå§¿æ€ï¼ˆå¤–å‚ï¼‰çš„è¿‡ç¨‹ã€‚ä¸€èˆ¬æ­¥éª¤ä¸ºï¼š

1. å¯»æ‰¾ä¸‰ç»´åœºæ™¯ç‚¹å’ŒäºŒç»´å›¾åƒç‚¹çš„å¯¹åº”å…³ç³»

    <div style="text-align: center">
        <img src="images/lec7/13.png" width=60% />
    </div>

2. æ ¹æ®è¿™ä¸€å…³ç³»æ¥ç¡®å®šç›¸æœºçš„ä½ç½®

    <div style="text-align: center">
        <img src="images/lec7/14.png" width=60% />
    </div>

è¿™ä¸€é—®é¢˜åˆç»å¸¸è¢«ç§°ä¸º **PnP**(perspective-n-point) é—®é¢˜ï¼ˆn æ˜¯ä¸‰ç»´ç‚¹ä¸ªæ•°ï¼›**å¾€å¾€å‡è®¾å†…å‚å·²çŸ¥**ï¼‰ã€‚è¯¥é—®é¢˜éœ€è€ƒè™‘ 6 ä¸ªæœªçŸ¥æ•°ï¼š3 ä¸ªå…³äºæ—‹è½¬ï¼Œ3 ä¸ªå…³äºå¹³ç§»ï¼Œå› æ­¤æ˜¯ä¸€ç§**å…­è‡ªç”±åº¦ä¼°è®¡**(6DoF estimation)ã€‚


#### P3P

ä¸‹é¢ä½¿ç”¨æœ€å°æ•°é‡çš„ç‚¹æ¥æ±‚è§£ç›¸æœºä½å§¿ã€‚

<div style="text-align: center">
    <img src="images/lec7/15.png" width=40% />
</div>

1. æ ¹æ®ä½™å¼¦å®šç†

    $$
    \begin{aligned}OA^2+OB^2-2OA\cdot OB\cdot\cos\langle a,b\rangle&=AB^2\\OB^2+OC^2-2OB\cdot OC\cdot\cos\langle b,c\rangle&=BC^2\\OA^2+OC^2-2OA\cdot OC\cdot\cos\langle a,c\rangle&=AC^2\end{aligned}
    $$

2. é™¤ä»¥ $OC^2$ï¼Œä»¤ $x=\frac{OA}{OC},y=\frac{OB}{OC}$

    $$
    \begin{gathered}\begin{aligned}x^2+y^2-2xy\cos\langle a,b\rangle=AB^2/OC^2\end{aligned}\\\begin{aligned}y^2+1^2-2y\cos\langle b,c\rangle=BC^2/OC^2\end{aligned}\\\begin{aligned}x^2+1^2-2x\cos\langle a,c\rangle=AC^2/OC^2\end{aligned}\end{gathered}
    $$

3. ä»¤ $v=\frac{AB^2}{OC^2},u=\frac{BC^2}{AB^2},w=\frac{AC^2}{AB^2}$

    $$
    \begin{aligned}x^2+y^2-2xy\cos\langle a,b\rangle-v&=0\\y^2+1^2-2y\cos\langle b,c\rangle-uv&=0\\x^2+1^2-2x\cos\langle a,c\rangle-wv&=0\end{aligned}
    $$

ä½¿ç”¨ $v$ é‡æ–°ç»„ç»‡ä¸Šè¿°æ–¹ç¨‹ï¼Œå¾—åˆ°ï¼š

$$
\begin{aligned}(1-u)y^2-ux^2-\cos\langle b,c\rangle y+2uxy\cos\langle a,b\rangle+1&=0\\(1-w)x^2-wy^2-\cos\langle a,c\rangle x+2wxy\cos\langle a,b\rangle+1&=0\end{aligned}
$$

ç°åœ¨å·²çŸ¥é‡ä¸º $\cos\langle a,b\rangle,\cos\langle b,c\rangle,\cos\langle a,c\rangle,u,w$ï¼ŒæœªçŸ¥é‡ä¸º $x, y$ï¼Œæ‰€ä»¥é—®é¢˜å·²ç»è½¬ä¸ºæ±‚è§£ä¸€ä¸ªäºŒå…ƒäºŒæ¬¡æ–¹ç¨‹(binary quadratic equation)ã€‚

ç”±äºäºŒå…ƒäºŒæ¬¡æ–¹ç¨‹æœ‰**å››ç§å¯èƒ½è§£**ï¼Œæˆ‘ä»¬åˆ©ç”¨**ä¸€ä¸ªé¢å¤–çš„ç‚¹**æ¥ç¡®å®šæœ€å¯èƒ½çš„é‚£ä¸€ä¸ªã€‚


#### PnP

PnP é—®é¢˜æ›´é€šç”¨çš„è§£æ³•æ˜¯å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼Œå…¶ç›®æ ‡å‡½æ•°ä¸ºï¼š

$$
\min_{R, t} \sum_i || \underbrace{p_i}_{\text{Given 2D points}} - \underbrace{K(RP_i + t)}_{\text{3D points projected to 2D}} ||^2
$$

- èƒ½å¤Ÿæœ€å°åŒ–**é‡æŠ•å½±è¯¯å·®**(reprojection error)
- ç”¨ **P3P** åˆå§‹åŒ–ï¼Œéšåç”¨**é«˜æ–¯-ç‰›é¡¿æ³•**ä¼˜åŒ–


## Structure from Motion

æ±‚è§£ SfM é—®é¢˜çš„æ­¥éª¤ï¼š

1. å‡è®¾å¯¹æ¯å°ç›¸æœºè€Œè¨€å†…å‚çŸ©é˜µ $K$ æ˜¯å·²çŸ¥çš„
2. å¯»æ‰¾ä¸€äº›å¯é çš„å¯¹åº”å…³ç³»
3. å¯»æ‰¾ç›¸å¯¹ç›¸æœºä½ç½® $\bm{p}$ å’Œæœå‘ $R$
4. å¯»æ‰¾åœºæ™¯çš„ä¸‰ç»´ç‚¹


### Epipolar Geometry

<!-- ???+ question "æ€è€ƒ"

    ä»¥ä¸‹å¯¹åº”ç‰¹å¾ç‚¹ä¹‹é—´æœ‰ä»€ä¹ˆå‡ ä½•å…³ç³»å—ï¼Ÿ

    <div style="text-align: center">
        <img src="images/lec7/16.png" width=60% />
    </div> -->

**å¯¹æå‡ ä½•**(epipolar geometry)æè¿°äº†ä¸‰ç»´ç‚¹åœ¨ä¸¤ä¸ªè§†å›¾ä¸­çš„äºŒç»´æŠ•å½±ï¼ˆ$u_l$ å’Œ $u_r$ï¼‰ä¹‹é—´çš„å‡ ä½•å…³ç³»ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡å¤šå¯¹äºŒç»´å¯¹åº”ç‚¹æ¥æ±‚è§£å¹³ç§»å‘é‡ $\bm{t}$ å’Œæ—‹è½¬çŸ©é˜µ $R$ã€‚

<div style="text-align: center">
    <img src="images/lec7/17.png" width=70% />
</div>

>è¯·åŠ¡å¿…å…³æ³¨å›¾ä¸­å°å­—å†…å®¹ï¼Œæœ‰åŠ©äºåç»­ç†è§£ã€‚çœ‹ä¸æ¸…çš„è¯å¯ç‚¹å‡»å›¾ç‰‡å…¨å±è§‚çœ‹ã€‚

- **æç‚¹**(epipole)ï¼šä¸€ä¸ªç›¸æœºçš„åŸç‚¹/é’ˆå­”åœ¨å¦ä¸€ä¸ªç›¸æœºè§†è§’ä¸‹çš„å›¾åƒç‚¹
    - ä¸Šå›¾çš„ $e_l, e_r$ å°±æ˜¯æç‚¹ï¼ˆä¸¤ä¸ªç›¸æœºä¸­å¿ƒè¿çº¿å’Œå„è‡ªåƒå¹³é¢çš„äº¤ç‚¹ï¼‰
    - å¯¹äºç»™å®šçš„ç›¸æœºå¯¹ï¼Œæç‚¹æ˜¯å”¯ä¸€çš„
    - å¯ç®€å•ç†è§£ä¸ºä¸€å°ç›¸æœºåœ¨å¦ä¸€æ¡ç›¸æœºæ‹æ‘„ç…§ç‰‡ä¸­å‡ºç°çš„ä½ç½®ï¼ˆä½†ä¸ä¸€å®šå§‹ç»ˆèƒ½åœ¨ç…§ç‰‡ä¸Šå‡ºç°ï¼‰
- åœºæ™¯ç‚¹ $P$ çš„**æå¹³é¢**(epipolar plane)ï¼šç”±ç›¸æœºåŸç‚¹ï¼ˆ$O_L, O_r$ï¼‰ã€æç‚¹ï¼ˆ$e_l, e_r$ï¼‰ä»¥åŠåœºæ™¯ç‚¹ $P$ å…±åŒæ„æˆçš„å¹³é¢
    - æ¯ä¸ªåœºæ™¯ç‚¹éƒ½ä½äºä¸€ä¸ª**å”¯ä¸€**çš„æå¹³é¢ä¸Š

- **å¯¹æçº¦æŸ**(epipolar constraints)ï¼šæå¹³é¢**æ³•å‘é‡**ä¸º $\bm{n} = \bm{t} \times \bm{x}_l$
    - $\bm{n}$ å’Œ $\bm{x}_l$ çš„ç‚¹ä¹˜ä¸º 0ï¼Œå³ï¼š$\bm{x}_l \cdot (\bm{t} \times \bm{x}_l) = 0$
    - å†™æˆçŸ©é˜µå½¢å¼ä¸ºï¼š

        $$
        \begin{align*}
        \begin{bmatrix} x_l & y_l & z_l \end{bmatrix}
        \begin{bmatrix}
        t_y z_l - t_z y_l \\
        t_z x_l - t_x z_l \\
        t_x y_l - t_y x_l
        \end{bmatrix} &= 0 \\
        \begin{bmatrix} x_l & y_l & z_l \end{bmatrix}
        \underbrace{
        \begin{bmatrix}
        0 & -t_z & t_y \\
        t_z & 0 & -t_x \\
        -t_y & t_x & 0
        \end{bmatrix}
        }_{T_\times}
        \begin{bmatrix} x_l \\ y_l \\ z_l \end{bmatrix} &= 0
        \end{align*}
        $$

ç”±äºå·²çŸ¥ $\bm{x}_l = R\bm{x}_r + \bm{t}$ï¼Œä»£å…¥ä¸Šè¿°å¯¹æçº¦æŸæ¡ä»¶å¾—åˆ°ï¼š

$$
\begin{align*}
\begin{bmatrix} x_l \\ y_l \\ z_l \end{bmatrix}^{\intercal}
\begin{bmatrix}
0 & -t_z & t_y \\
t_z & 0 & -t_x \\
-t_y & t_x & 0
\end{bmatrix}
\begin{bmatrix}
r_{11} & r_{12} & r_{13} \\
r_{21} & r_{22} & r_{23} \\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
\begin{bmatrix} x_r \\ y_r \\ z_r \end{bmatrix}
+
\begin{bmatrix}
0 & -t_z & t_y \\
t_z & 0 & -t_x \\
-t_y & t_x & 0
\end{bmatrix}
\begin{bmatrix} x_r \\ y_r \\ z_r \end{bmatrix} &= 0 \\
\begin{bmatrix} x_l & y_l & z_l \end{bmatrix}
\underbrace{
\begin{bmatrix}
e_{11} & e_{12} & e_{13} \\
e_{21} & e_{22} & e_{23} \\
e_{31} & e_{32} & e_{33}
\end{bmatrix}
}_{\text{Essential Matrix }E}
\begin{bmatrix} x_r \\ y_r \\ z_r \end{bmatrix} &= 0
\end{align*}
$$


### Essential Matrix

å¯ä»¥å°†**æœ¬è´¨çŸ©é˜µ**(essential matrix) $E$ åˆ†è§£ä¸ºï¼š$E = T_\times R$ï¼Œå³ï¼š

$$
\begin{bmatrix}
e_{11} & e_{12} & e_{13} \\
e_{21} & e_{22} & e_{23} \\
e_{31} & e_{32} & e_{33}
\end{bmatrix}
= \begin{bmatrix}
0 & -t_z & t_y \\
t_z & 0 & -t_x \\
-t_y & t_x & 0
\end{bmatrix}
\begin{bmatrix}
r_{11} & r_{12} & r_{13} \\
r_{21} & r_{22} & r_{23} \\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
$$

ç”±äº $T_\times$ æ˜¯<span style="color: cornflowerblue">æ–œå¯¹ç§°</span>(skew-symmetric) $(a_{ij} = a_{-ji})$ ä¸” $R$ æ˜¯<span style="color: yellogreen">æ ‡å‡†æ­£äº¤</span>çŸ©é˜µï¼Œæ‰€ä»¥å¯åˆ©ç”¨**å¥‡å¼‚å€¼åˆ†è§£**(singular value decomposition)ä»ç§¯ä¸­è§£è€¦å‡º $L_\times$ å’Œ $R$ã€‚

è‹¥ $E$ å·²çŸ¥ï¼Œä¾¿å¯è®¡ç®— $\bm{t}, R$ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯å¦‚ä½•æ‰¾åˆ° $E$ã€‚

è§£å†³æ€è·¯ï¼šå°†åœºæ™¯ç‚¹ç›¸å¯¹äºå·¦ä¾§ç›¸æœºçš„ä¸‰ç»´ä½ç½® $(x_l, y_l, z_l)$ ä¸å…¶ç›¸å¯¹äºå³ä¾§ç›¸æœºçš„ä¸‰ç»´ä½ç½® $(x_r, y_r, z_r)$ è”ç³»èµ·æ¥ï¼Œå¾—åˆ°ï¼š

$$
\begin{aligned}
& \bm{x}_l^T E \bm{x}_r = 0 \\
\begin{bmatrix} x_l & y_l & z_l \end{bmatrix} &
\begin{bmatrix}
e_{11} & e_{12} & e_{13} \\
e_{21} & e_{22} & e_{23} \\
e_{31} & e_{32} & e_{33}
\end{bmatrix}
\begin{bmatrix} x_r \\ y_r \\ z_r \end{bmatrix} = 0
\end{aligned}
$$

ç›®å‰æˆ‘ä»¬è¿˜ä¸çŸ¥é“ $\bm{x}_l, \bm{x}_r$ï¼Œä½†æˆ‘ä»¬çŸ¥é“åœ¨å›¾åƒåæ ‡ä¸­çš„å¯¹åº”ç‚¹ï¼Œå³ï¼š

- å·¦ä¾§ç›¸æœº

    $$
    z_l
    \begin{bmatrix}
    u_l \\
    v_l \\
    1
    \end{bmatrix}
    = \underbrace{\begin{bmatrix}
    f_x^{(l)} & 0 & o_x^{(l)} \\
    0 & f_y^{(l)} & o_y^{(l)} \\
    0 & 0 & 1
    \end{bmatrix}}_{K_l}
    \begin{bmatrix}
    x_l \\
    y_l \\
    z_l
    \end{bmatrix}
    $$

    è§£å¾—ï¼š

    $$
    \bm{x}_l{}^T=\begin{bmatrix}u_l&v_l&1\end{bmatrix}\mathrm{z}_l{K_l^{-1}}^T
    $$

- å³ä¾§ç›¸æœº

    $$
    z_r
    \begin{bmatrix}
    u_r \\
    v_r \\
    1
    \end{bmatrix}
    = \underbrace{\begin{bmatrix}
    f_x^{(r)} & 0 & o_x^{(r)} \\
    0 & f_y^{(r)} & o_y^{(r)} \\
    0 & 0 & 1
    \end{bmatrix}}_{K_r}
    \begin{bmatrix}
    x_r \\
    y_r \\
    z_r
    \end{bmatrix}
    $$

    è§£å¾—ï¼š

    $$
    \bm{x}_r=K_r^{-1}z_r\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}
    $$

ä»£å…¥å‰é¢çš„æ–¹ç¨‹ï¼Œå¾—åˆ°ï¼š

$$
\begin{bmatrix}u_l&v_l&1\end{bmatrix}\cancel{z_l}K_l^{-1^T}\begin{bmatrix}e_{11}&e_{12}&e_{13}\\e_{21}&e_{22}&e_{23}\\e_{31}&e_{32}&e_{33}\end{bmatrix}K_r^{-1}\cancel{z_r}\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}=0
$$

>æ³¨æ„ï¼šåœºæ™¯çš„æ·±åº¦ä¸å½±å“æçº¿çº¦æŸï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ— è§†æ–¹ç¨‹ä¸­çš„ $z_l, z_r$ã€‚

å°†ä¸Šè¿°æ–¹ç¨‹å†™ä¸ºï¼š

$$
\begin{aligned}
\begin{bmatrix} u_l & v_l & 1 \end{bmatrix} &
\begin{bmatrix}
f_{11} & f_{12} & f_{13} \\
f_{21} & f_{22} & f_{23} \\
f_{31} & f_{32} & f_{33}
\end{bmatrix}
\begin{bmatrix} u_r \\ v_r \\ 1 \end{bmatrix}= 0 \\
E &= K_l^T F K_r
\end{aligned}
$$

ä¸­é—´è¿™ä¸ªçŸ©é˜µå«åš**åŸºç¡€çŸ©é˜µ**(fundamental matrix) $F$ã€‚

åŸºç¡€çŸ©é˜µä½œç”¨åœ¨é½æ¬¡åæ ‡ä¸Šï¼š

$$
\begin{bmatrix}u_l&v_l&1\end{bmatrix}\begin{bmatrix}f_{11}&f_{12}&f_{13}\\f_{21}&f_{22}&f_{23}\\f_{31}&f_{32}&f_{33}\end{bmatrix}\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}=0 \quad \Rightarrow \quad \begin{bmatrix}u_l&v_l&1\end{bmatrix}\begin{bmatrix}kf_{11}&kf_{12}&kf_{13}\\kf_{21}&kf_{22}&kf_{23}\\kf_{31}&kf_{32}&kf_{33}\end{bmatrix}\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}=0
$$

å¯ä»¥çœ‹åˆ°ï¼ŒåŸºç¡€çŸ©é˜µ $F, kF$ æè¿°ç›¸åŒçš„å¯¹æå‡ ä½•ï¼Œä¹Ÿå°±æ˜¯è¯´ $F$ çš„å®šä¹‰**ä¸å°ºåº¦æ— å…³**ã€‚æ‰€ä»¥é€šå¸¸ä¼šç»™ $F$ æ·»åŠ ä¸€ä¸ªçº¦æŸï¼š$\|f\|^2 = 1$ï¼Œå³ç”± $F$ çš„å…ƒç´ æ„æˆçš„å‘é‡é•¿åº¦ä¸º 1ã€‚


### Relative Camera Pose Estimation

**ç›¸å¯¹ç›¸æœºä½å§¿ä¼°è®¡**(relative camera position estimation)æ˜¯æŒ‡åœ¨å·¦å³å›¾åƒä¸­å¯»æ‰¾ä¸€ç»„å¯¹åº”çš„ç‰¹å¾ç‚¹ï¼ˆè‡³å°‘ 8 ä¸ªï¼‰ï¼ˆæ¯”å¦‚ä½¿ç”¨ SIFT æ–¹æ³•æˆ–æ‰‹åŠ¨é€‰å–ï¼‰ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š

1. å¯¹äºæ¯ä¸€ä¸ªå¯¹åº”å…³ç³» $i$ï¼Œå†™å‡ºå¯¹æçº¦æŸ
2. é‡æ–°æ’åˆ—é¡¹ï¼Œæ„æˆçº¿æ€§æ–¹ç¨‹ç»„

    $$
    \underbrace{
    \begin{bmatrix}
    u_l^{(1)}u_r^{(1)} & u_l^{(1)}v_r^{(1)} & u_l^{(1)} & v_l^{(1)}u_r^{(1)} & v_l^{(1)}v_r^{(1)} & v_l^{(1)} & u_r^{(1)} & v_r^{(1)} & 1 \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    u_l^{(i)}u_r^{(i)} & u_l^{(i)}v_r^{(i)} & u_l^{(i)} & v_l^{(i)}u_r^{(i)} & v_l^{(i)}v_r^{(i)} & v_l^{(i)} & u_r^{(i)} & v_r^{(i)} & 1 \\
    \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
    u_l^{(m)}u_r^{(m)} & u_l^{(m)}v_r^{(m)} & u_l^{(m)} & v_l^{(m)}u_r^{(m)} & v_l^{(m)}v_r^{(m)} & v_l^{(m)} & u_r^{(m)} & v_r^{(m)} & 1 \\
    \end{bmatrix}
    }_{A\ (\text{Known})}
    %
    \underbrace{
    \begin{bmatrix}
    f_{11} \\ f_{12} \\ f_{13} \\ f_{21} \\ f_{22} \\ f_{23} \\ f_{31} \\ f_{32} \\ f_{33}
    \end{bmatrix}
    }_{\bm{f}\ (\text{Unknown})}
    = \begin{bmatrix}
    0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0
    \end{bmatrix}
    $$

    å³ $A\bm{f} = 0$

3. å¯»æ‰¾åŸºç¡€çŸ©é˜µ $F$ çš„æœ€å°äºŒä¹˜è§£ï¼š$A\bm{f}$ å°½å¯èƒ½æ¥è¿‘ 0 ä¸” $\|\bm{f}\|^2 = 1$ï¼Œå³ï¼ˆçº¦æŸä¸ºçº¿æ€§æœ€å°äºŒä¹˜é—®é¢˜ï¼‰

    $$
    \min_{\bm{f}}\|A\bm{f}\|^2\text{ such that }\|\bm{f}\|^2=1
    $$

    >æ˜¯ä¸æ˜¯æ„Ÿè§‰ä¸Šè¿°æ­¥éª¤ä¼¼æ›¾ç›¸è¯†ï¼Ÿå‰é¢ä»‹ç»çš„ç›¸æœºæ ‡å®šä¸­[æ±‚è§£æŠ•å½±çŸ©é˜µ](#solving-p)ï¼Œä»¥åŠå›¾åƒæ‹¼æ¥ä¸­çš„[å•åº”çŸ©é˜µ](6.md#projective-transformation)ä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„æ±‚è§£æ–¹æ³•ã€‚

    ä¹‹åå°†è§£ $\bm{f}$ é‡æ–°ç»„ç»‡ï¼Œæ„æˆåŸºç¡€çŸ©é˜µ $F$

4. ä»å·²çŸ¥çš„å·¦å³å†…å‚ç›¸æœºçŸ©é˜µå’ŒåŸºç¡€çŸ©é˜µ $F$ è®¡ç®—æœ¬è´¨çŸ©é˜µ $E$

    $$
    E = K_l^T F K_r
    $$

5. ä» $E$ ä¸­æå– $R, \bm{t}$ï¼ˆä½¿ç”¨**å¥‡å¼‚å€¼åˆ†è§£**ï¼‰

    $$
    E = T_\times R
    $$


### Triangulation

ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†äºŒç»´ç‰¹å¾ç‚¹å’Œç›¸æœºå‚æ•°ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šåœºæ™¯ç‚¹çš„ä¸‰ç»´åæ ‡ã€‚

<div style="text-align: center">
    <img src="images/lec7/19.png" width=60% />
</div>

$$
\underbrace{
\begin{bmatrix}u_l\\v_l\\1\end{bmatrix}\equiv\begin{bmatrix}f_x^{(l)}&0&o_x^{(l)}&0\\0&f_y^{(l)}&o_y^{(l)}&0\\0&0&1&0\end{bmatrix}\begin{bmatrix}x_l\\y_l\\z_l\\1\end{bmatrix}
}_{\text{Left Camera Image Equation}}
\quad
\underbrace{
\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}\equiv\begin{bmatrix}f_x^{(r)}&0&o_x^{(r)}&0\\0&f_y^{(r)}&o_y^{(r)}&0\\0&0&1&0\end{bmatrix}\begin{bmatrix}x_r\\y_r\\z_r\\1\end{bmatrix}
}_{\text{Right Camera Image Equation}}
$$

å¹¶ä¸”æˆ‘ä»¬å·²çŸ¥ä¸¤å°ç›¸æœºçš„ç›¸å¯¹ä½ç½®å’Œæœå‘ï¼š

$$
\begin{bmatrix}
x_l \\
y_l \\
z_l \\
1
\end{bmatrix}
= \begin{bmatrix}
r_{11} & r_{12} & r_{13} & t_x \\
r_{21} & r_{22} & r_{23} & t_y \\
r_{31} & r_{32} & r_{33} & t_z \\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
x_r \\
y_r \\
z_r \\
1
\end{bmatrix}
$$

å¯ä»¥å¾—åˆ°ï¼š

- å·¦ç›¸æœºå›¾åƒæ–¹ç¨‹

    $$
    \begin{align*}
    \begin{bmatrix}
    u_l \\
    v_l \\
    1
    \end{bmatrix}
    &\equiv
    \begin{bmatrix}
    f_x^{(l)} & 0 & o_x^{(l)} & 0 \\
    0 & f_y^{(l)} & o_y^{(l)} & 0 \\
    0 & 0 & 1 & 0
    \end{bmatrix}
    \begin{bmatrix}
    r_{11} & r_{12} & r_{13} & t_x \\
    r_{21} & r_{22} & r_{23} & t_y \\
    r_{31} & r_{32} & r_{33} & t_z \\
    0 & 0 & 0 & 1
    \end{bmatrix}
    \begin{bmatrix}
    x_r \\
    y_r \\
    z_r \\
    1
    \end{bmatrix} \\
    \tilde{\bm{u}}_l &= P_l \tilde{\bm{x}}_r
    \end{align*}
    $$

- å³ç›¸æœºå›¾åƒæ–¹ç¨‹

    $$
    \begin{align*}
    \begin{bmatrix}
    u_r \\
    v_r \\
    1
    \end{bmatrix}
    &\equiv
    \begin{bmatrix}
    f_x^{(r)} & 0 & o_x^{(r)} & 0 \\
    0 & f_y^{(r)} & o_y^{(r)} & 0 \\
    0 & 0 & 1 & 0
    \end{bmatrix}
    \begin{bmatrix}
    x_r \\
    y_r \\
    z_r \\
    1
    \end{bmatrix} \\
    \tilde{\bm{u}}_r &= M_{int_r} \tilde{\bm{x}}_r
    \end{align*}
    $$

å›¾åƒæ–¹ç¨‹ï¼š

$$
\widetilde{\bm{u}}_{\bm{r}}=M_{r}\tilde{\bm{x}}_{\bm{r}}\quad\widetilde{\bm{u}}_{\bm{l}}=P_{l}\tilde{\bm{x}}_{\bm{r}}\\\begin{bmatrix}u_r\\v_r\\1\end{bmatrix}\equiv\begin{bmatrix}m_{11}&m_{12}&m_{13}&m_{14}\\m_{21}&m_{22}&m_{23}&m_{24}\\m_{31}&m_{32}&m_{33}&m_{34}\end{bmatrix}\begin{bmatrix}x_r\\y_r\\z_r\\1\end{bmatrix}\quad\begin{bmatrix}u_l\\v_l\\1\end{bmatrix}\equiv\begin{bmatrix}p_{11}&p_{12}&p_{13}&p_{14}\\p_{21}&p_{22}&p_{23}&p_{24}\\p_{31}&p_{32}&p_{33}&p_{34}\end{bmatrix}\begin{bmatrix}x_r\\y_r\\z_r\\1\end{bmatrix}
$$

é‡æ–°ç»„ç»‡é¡¹ï¼š

$$
\underbrace{
\begin{bmatrix}u_rm_{31}-m_{11}&u_rm_{32}-m_{12}&u_rm_{33}-m_{13}\\v_rm_{31}-m_{21}&v_rm_{32}-m_{22}&v_rm_{33}-m_{23}\\u_lp_{31}-p_{11}&u_lp_{32}-p_{12}&u_lp_{33}-p_{13}\\v_lp_{31}-p_{21}&v_lp_{32}-p_{22}&v_lp_{33}-p_{23}\end{bmatrix}}_{A_{4 \times 3}\ (\text{Known})}
\underbrace{
\begin{bmatrix}x_r\\y_r\\z_r\end{bmatrix}
}_{\bm{x}_r\ (\text{Unknown})}
= \underbrace{\begin{bmatrix}m_{14}-m_{34}\\m_{24}-m_{34}\\p_{14}-p_{34}\\p_{24}-p_{34}\end{bmatrix}}_{\bm{b}_{4 \times 1}\ (\text{Known})}
$$

ä»ä»¥ä¸‹æ–¹ç¨‹å¾—åˆ°æœ€å°äºŒä¹˜è§£ï¼š

$$
\bm{x}_r=\left(A^TA\right)^{-1}A^T\bm{b}
$$

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå°„çº¿ $\bm{x}_l, \bm{x}_r$ ä¸ä¼šå’Œç‚¹ $P$ ç²¾ç¡®ç›¸äº¤ï¼š

<div style="text-align: center">
    <img src="images/lec7/20.png" width=50% />
</div>

æ‰€ä»¥éœ€è¦æœ€å°åŒ–**é‡æŠ•å½±è¯¯å·®**(reprojection error)ï¼š

$$
cost(\bm{P})=||\bm{u}_l-\widehat{\bm{u}}_l||^2+||\bm{u}_r-\widehat{\bm{u}}_r||^2
$$

<div style="text-align: center">
    <img src="images/lec7/21.png" width=50% />
</div>

æˆ‘ä»¬æ˜¯å¦ä¹Ÿèƒ½ä¼˜åŒ– $R, \bm{t}$ï¼ˆ~~è¿™ä¸ªé—®é¢˜è¯¾ä¸Šå¥½åƒç›´æ¥è·³è¿‡äº†ğŸ˜…~~ï¼‰


### Multi-frame Structure from Motion

ä¹‹å‰è®²çš„éƒ½æ˜¯åŸºäºä¸¤å¼ ä¸åŒè§†è§’ä¸‹çš„å›¾åƒæ¥è®¡ç®—ä¸‰ç»´åæ ‡ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¹Ÿèƒ½æ ¹æ®æ›´å¤šè§†è§’ä¸‹çš„å›¾åƒæ¥è®¡ç®—ä¸‰ç»´ç»“æ„ã€‚

<div style="text-align: center">
    <img src="images/lec7/22.png" width=40% />
</div>

ç»™å®š $m$ å¼ åŒ…å« $n$ ä¸ªä¸‰ç»´ç‚¹çš„å›¾åƒï¼š

$$
\bm{u}_j^{(i)}=P_{proj}^{(i)}\bm{P}_j \quad (i = 1,...,m \text{ and } j = 1,...,n)
$$

å³ä» $mn$ ä¸ªå¯¹åº”çš„äºŒç»´ç‚¹ $\bm{u}_j^{(i)}$ ä¼°è®¡ $m$ ä¸ªæŠ•å½±çŸ©é˜µ $P_{proj}^{(i)}$ å’Œ $n$ ä¸ªä¸‰ç»´ç‚¹ $P_j$ã€‚è§£å†³è¯¥é—®é¢˜çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆå§‹åŒ–ç›¸æœºè¿åŠ¨å’Œåœºæ™¯ç»“æ„

    <div style="text-align: center">
        <img src="images/lec7/23.png" width=30% />
    </div>

2. å¯¹äºæ¯ä¸ªé¢å¤–çš„è§†è§’
    - ç¡®å®šæ–°ç›¸æœºçš„æŠ•å½±çŸ©é˜µï¼Œä½¿ç”¨å…¶å›¾åƒä¸­æ‰€æœ‰å¯è§çš„å·²çŸ¥ä¸‰ç»´ç‚¹

        <div style="text-align: center">
            <img src="images/lec7/24.png" width=40% />
        </div>

    - ä¼˜åŒ–å¹¶æ‰©å±•ç»“æ„ï¼šè®¡ç®—æ–°çš„ä¸‰ç»´ç‚¹ï¼Œé‡æ–°ä¼˜åŒ–è¯¥ç›¸æœºä¹Ÿèƒ½è§‚å¯Ÿåˆ°çš„ç°æœ‰ç‚¹

        <div style="text-align: center">
            <img src="images/lec7/25.png" width=30% />
        </div>

3. ä¼˜åŒ–ç»“æ„ä¸è¿åŠ¨ï¼š**å…‰æŸæ³•å¹³å·®**(bundle adjustment)

    <div style="text-align: center">
        <img src="images/lec7/26.png" width=30% />
    </div>

    - å…‰æŸæ³•å¹³å·®ï¼šé€šè¿‡æœ€å°åŒ–æ‰€æœ‰å¸§çš„**é‡æŠ•å½±è¯¯å·®**æ¥ä¼˜åŒ–ä¸‰ç»´ç‚¹å’Œç›¸æœºå‚æ•°

        $$
        E(P_{proj},\bm{P})=\sum_{i=1}^m\sum_{j=1}^n||u_j^{(i)}-P_{proj}^{(i)}\bm{P}_j||^2
        $$

        ä½¿ç”¨ [Levenberg-Marquardt ç®—æ³•](https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm)ï¼Œä¾‹å¦‚ Google çš„ [Ceres-Solver](https://github.com/ceres-solver/ceres-solver)


### COLMAP

[**COLMAP**](https://colmap.github.io) æ˜¯ä¸€ä¸ªé€šç”¨çš„**è¿åŠ¨æ¢å¤ç»“æ„**ï¼ˆSfMï¼‰å’Œ**å¤šè§†å›¾ç«‹ä½“**ï¼ˆMVSï¼‰ç®¡é“ï¼Œå…·æœ‰å›¾å½¢å’Œå‘½ä»¤è¡Œç•Œé¢ã€‚å®ƒä¸ºæœ‰åºå’Œæ— åºå›¾åƒé›†åˆçš„é‡å»ºæä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½ã€‚

<div style="text-align: center">
    <img src="images/lec7/27.png" width=70% />
</div>

<div style="text-align: center">
    <img src="images/lec7/28.png" width=70% />
</div>

>ä¹‹åçš„æŸæ¬¡å®éªŒä»¥åŠå¤§ä½œä¸šçš„ä¸‰ç»´é‡å»ºé€‰é¢˜éƒ½ä¼šç”¨åˆ°è¿™ä¸€å·¥å…·ã€‚

å¢é‡ SfM ç®¡çº¿ï¼š

<div style="text-align: center">
    <img src="images/lec7/29.png" width=70% />
</div>